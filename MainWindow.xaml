<Window x:Class="PhotoRenamer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:viewmodels="clr-namespace:PhotoRenamer.ViewModels"
        mc:Ignorable="d"
        Title="Photo Metadata Renamer" 
        Height="800" Width="1200"
        MinHeight="600" MinWidth="900"
        Background="{DynamicResource MaterialDesignPaper}"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="13"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="Auto"
        FontFamily="{DynamicResource MaterialDesignFont}"
        d:DataContext="{d:DesignInstance viewmodels:MainViewModel}">
    
    <Window.InputBindings>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding SelectFolderCommand}"/>
        <KeyBinding Key="G" Modifiers="Ctrl" Command="{Binding GenerateSuggestionsCommand}"/>
        <KeyBinding Key="R" Modifiers="Ctrl" Command="{Binding ApplyRenamesCommand}"/>
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}"/>
        <KeyBinding Key="A" Modifiers="Ctrl" Command="{Binding SelectAllCommand}"/>
        <KeyBinding Key="F5" Command="{Binding RefreshFolderCommand}"/>
    </Window.InputBindings>

    <materialDesign:DialogHost>
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <materialDesign:ColorZone Mode="PrimaryDark" Padding="16" Grid.Row="0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Horizontal" Grid.Column="0">
                        <materialDesign:PackIcon Kind="Image" Width="32" Height="32" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        <TextBlock Text="Photo Metadata Renamer" 
                                   Style="{StaticResource MaterialDesignHeadline5TextBlock}" 
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Grid.Column="2" HorizontalAlignment="Right">
                        <Button Style="{StaticResource MaterialDesignFlatLightBgButton}"
                                Command="{Binding UndoCommand}"
                                ToolTip="Undo last operation (Ctrl+Z)"
                                Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Undo" VerticalAlignment="Center"/>
                                <TextBlock Text="Undo" Margin="8,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </materialDesign:ColorZone>

            <!-- Toolbar -->
            <materialDesign:Card Grid.Row="1" Margin="16,16,16,0" Padding="16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Folder Selection -->
                    <StackPanel Orientation="Horizontal" Grid.Column="0">
                        <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                Command="{Binding SelectFolderCommand}"
                                ToolTip="Select folder (Ctrl+O)"
                                Margin="0,0,16,0">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="FolderOpen" VerticalAlignment="Center"/>
                                <TextBlock Text="Select Folder" Margin="8,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <TextBlock Text="{Binding SelectedFolder, TargetNullValue='No folder selected'}" 
                                   VerticalAlignment="Center"
                                   MaxWidth="300"
                                   TextTrimming="CharacterEllipsis"
                                   Opacity="0.8"/>

                        <CheckBox Content="Include Subfolders" 
                                  IsChecked="{Binding RecursiveScan}"
                                  Margin="24,0,0,0"
                                  VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Pattern Selection -->
                    <!-- Pattern Selection & Custom Text -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="16,0">
                        <ComboBox ItemsSource="{Binding AvailablePatterns}"
                                  SelectedItem="{Binding SelectedPattern}"
                                  DisplayMemberPath="Name"
                                  materialDesign:HintAssist.Hint="Naming Pattern"
                                  Width="180"
                                  Margin="0,0,16,0"
                                  VerticalAlignment="Center"/>
                                  
                        <TextBox Text="{Binding CustomTag, UpdateSourceTrigger=PropertyChanged}"
                                 materialDesign:HintAssist.Hint="Custom Text (optional)"
                                 Width="160"
                                 VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Action Buttons -->
                    <Button Grid.Column="2" 
                            Style="{StaticResource MaterialDesignRaisedLightButton}"
                            Command="{Binding GenerateSuggestionsCommand}"
                            ToolTip="Generate suggestions (Ctrl+G)"
                            Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="AutoFix" VerticalAlignment="Center"/>
                            <TextBlock Text="Generate Suggestions" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <Button Grid.Column="3" 
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Command="{Binding ApplyRenamesCommand}"
                            ToolTip="Apply renames (Ctrl+R)">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="RenameBox" VerticalAlignment="Center"/>
                            <TextBlock Text="Apply Renames" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- Cancel Button (visible during processing) -->
                    <Button Grid.Column="3" 
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding CancelOperationCommand}"
                            Visibility="{Binding CanCancel, Converter={StaticResource BooleanToVisibilityConverter}}"
                            Foreground="Orange"
                            BorderBrush="Orange"
                            Margin="8,0,0,0"
                            ToolTip="Cancel current operation">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Cancel" VerticalAlignment="Center"/>
                            <TextBlock Text="Cancel" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <StackPanel Grid.Column="4" Orientation="Horizontal" Margin="16,0,0,0">
                        <Button Style="{StaticResource MaterialDesignFlatButton}"
                                Command="{Binding SelectAllCommand}"
                                Content="Select All"
                                ToolTip="Ctrl+A"
                                Margin="0,0,4,0"/>
                        <Button Style="{StaticResource MaterialDesignFlatButton}"
                                Command="{Binding DeselectAllCommand}"
                                Content="Deselect All"/>
                    </StackPanel>
                </Grid>
            </materialDesign:Card>

            <!-- Main Content - Photo List -->
            <materialDesign:Card Grid.Row="2" Margin="16" Padding="0">
                <Grid>
                    <DataGrid ItemsSource="{Binding PhotoFiles}"
                              SelectedItem="{Binding SelectedPhoto}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              IsReadOnly="False"
                              SelectionMode="Single"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              materialDesign:DataGridAssist.ColumnHeaderPadding="12"
                              materialDesign:DataGridAssist.CellPadding="12,8">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Binding="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" 
                                                    Header="" Width="50"/>
                            
                            <!-- Thumbnail Column -->
                            <DataGridTemplateColumn Header="" Width="70" IsReadOnly="True">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Image Source="{Binding Thumbnail, Converter={StaticResource ByteArrayToImageConverter}}"
                                               Width="60" Height="60" 
                                               Stretch="UniformToFill"
                                               RenderOptions.BitmapScalingMode="HighQuality"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <DataGridTextColumn Binding="{Binding FileName}" 
                                                Header="Original Name" 
                                                Width="150"
                                                IsReadOnly="True"/>
                            
                            <DataGridTextColumn Binding="{Binding SelectedSuggestion, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" 
                                                Header="New Name" 
                                                Width="250">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="{DynamicResource SecondaryHueMidBrush}"/>
                                        <Setter Property="FontWeight" Value="Medium"/>
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                                <DataGridTextColumn.EditingElementStyle>
                                    <Style TargetType="TextBox">
                                        <Setter Property="Foreground" Value="{DynamicResource SecondaryHueMidBrush}"/>
                                        <Setter Property="Background" Value="{DynamicResource MaterialDesign.Brush.Background}"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Padding" Value="2"/>
                                    </Style>
                                </DataGridTextColumn.EditingElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding DateTakenDisplay}" 
                                                Header="Date Taken" 
                                                Width="140"
                                                IsReadOnly="True"/>

                            <DataGridTextColumn Binding="{Binding CameraDisplay}" 
                                                Header="Camera" 
                                                Width="150"
                                                IsReadOnly="True"/>

                            <DataGridTextColumn Binding="{Binding GpsDisplay}" 
                                                Header="GPS" 
                                                Width="150"
                                                IsReadOnly="True"/>

                            <DataGridTextColumn Binding="{Binding FileSizeDisplay}" 
                                                Header="Size" 
                                                Width="80"
                                                IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Loading Overlay -->
                    <Grid Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}"
                          Background="#80000000">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                                         Value="{Binding ProcessingProgress}"
                                         IsIndeterminate="False"
                                         Width="60" Height="60"/>
                            <TextBlock Text="{Binding StatusMessage}" 
                                       Margin="0,16,0,0"
                                       HorizontalAlignment="Center"
                                       Style="{StaticResource MaterialDesignBody1TextBlock}"/>
                        </StackPanel>
                    </Grid>

                    <!-- Empty State -->
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                Visibility="{Binding PhotoFiles.Count, Converter={StaticResource InverseIntToVisibilityConverter}}">
                        <materialDesign:PackIcon Kind="ImageMultiple" 
                                                 Width="80" Height="80" 
                                                 Opacity="0.3"
                                                 HorizontalAlignment="Center"/>
                        <TextBlock Text="No photos loaded" 
                                   Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                   Opacity="0.5"
                                   Margin="0,16,0,8"
                                   HorizontalAlignment="Center"/>
                        <TextBlock Text="Select a folder to scan for photos" 
                                   Style="{StaticResource MaterialDesignBody2TextBlock}"
                                   Opacity="0.4"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </materialDesign:Card>

            <!-- Status Bar -->
            <materialDesign:ColorZone Mode="PrimaryDark" Grid.Row="3" Padding="16,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="{Binding StatusMessage}" 
                               VerticalAlignment="Center"
                               Style="{StaticResource MaterialDesignBody2TextBlock}"/>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <TextBlock Text="{Binding PhotoFiles.Count, StringFormat='Total: {0} photos'}"
                                   Margin="0,0,16,0"
                                   VerticalAlignment="Center"
                                   Opacity="0.7"/>
                        <ProgressBar Value="{Binding ProcessingProgress}" 
                                     Width="150" 
                                     Height="6"
                                     Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </Grid>
            </materialDesign:ColorZone>
        </Grid>
    </materialDesign:DialogHost>
</Window>
